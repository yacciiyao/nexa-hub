<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Nexa-Hub · Chat</title>
  <style>
    /* 页面整体：占满视窗，高度自适应，底部输入栏始终可见 */
    html, body {
      height: 100%;
      margin: 0;
      background: #f4f4f4;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
    }
    .app {
      height: 100%;
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      background: #fff;
      box-shadow: 0 2px 16px rgba(0,0,0,.06);
    }

    /* 顶部 */
    .header {
      padding: 12px 16px;
      font-weight: 700;
      font-size: 20px;
      border-bottom: 1px solid #eee;
    }
    .toolbar {
      padding: 8px 16px;
      border-bottom: 1px solid #f2f2f2;
    }

    /* 对话区域：可滚动，占据剩余空间 */
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px 8px;
      background: #f6f6f6;
    }

    /* 微信风格：左右两侧消息 */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      margin: 10px 0;
      max-width: 80%;
    }
    .left  { justify-content: flex-start; }
    .right { justify-content: flex-end; margin-left: auto; }

    .avatar {
      width: 36px; height: 36px; border-radius: 50%; flex: 0 0 36px;
      background: #ddd; object-fit: cover;
    }

    .bubble {
      position: relative;
      padding: 10px 12px;
      border-radius: 8px;
      line-height: 1.5;
      word-break: break-word;
      background: #fff;           /* AI：白色 */
      box-shadow: 0 1px 1px rgba(0,0,0,.03);
    }
    .right .bubble {
      background: #9fe770;        /* 你：绿色 */
    }

    /* 底部输入栏：粘在容器底部，不遮挡 */
    .composer {
      position: sticky; bottom: 0; left: 0; right: 0;
      padding: 10px 12px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex; gap: 10px;
    }
    .composer input[type="text"]{
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
      background: #fafafa;
    }
    .composer button{
      padding: 8px 16px;
      border: none;
      border-radius: 18px;
      background: #25a244; color: #fff; cursor: pointer;
    }
    .composer button:disabled { opacity: .6; cursor: not-allowed; }

    /* 让聊天区底部留出一点空间，避免被粘性输入栏视觉挤压 */
    .chat-bottom-spacer { height: 8px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">Nexa-Hub - AI Chat</div>

    <div class="toolbar">
      选择模型：
      <select id="model">
        <option value="openai:gpt-3.5">OpenAI GPT-3.5</option>
        <option value="openai:gpt-4o-mini">OpenAI GPT-4o mini</option>
        <option value="qwen:turbo">Qwen Turbo</option>
        <option value="gemini:1.5">Gemini 1.5</option>
      </select>
    </div>

    <div id="chat" class="chat">
      <!-- 示例首条欢迎语（可删） -->
      <div class="msg-row left">
        <img class="avatar" src="https://via.placeholder.com/72x72.png?text=AI" alt="AI">
        <div class="bubble">你好，我是你的 AI 助手～</div>
      </div>
      <div class="chat-bottom-spacer"></div>
    </div>

    <div class="composer">
      <input id="q" type="text" placeholder="请输入问题…" />
      <button id="send">发送</button>
    </div>
  </div>

  <script>
    // —— 配置：不要写死后端 —— 可改成你的实际地址
    const API_BASE = localStorage.getItem('NEXA_API') || 'http://127.0.0.1:8000';
    const CHAT_API = `${API_BASE}/api/chat/`;

    const chatEl = document.getElementById('chat');
    const input  = document.getElementById('q');
    const sendBtn= document.getElementById('send');
    const modelEl= document.getElementById('model');

    function addMsg({side, text}) {
      const row = document.createElement('div');
      row.className = `msg-row ${side}`;

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = side === 'right'
        ? 'https://via.placeholder.com/72x72.png?text=Me'
        : 'https://via.placeholder.com/72x72.png?text=AI';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;

      if (side === 'left') {
        row.appendChild(avatar);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
        row.appendChild(avatar);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;

      // 先显示用户消息
      addMsg({side: 'right', text});
      input.value = '';
      input.focus();

      // 调后端
      sendBtn.disabled = true;
      try {
        const res = await fetch(CHAT_API, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            query: text,
            model: modelEl.value,
            session_id: 'web-default'
          })
        });
        const data = await res.json();
        const aiText = data.text || data.answer || JSON.stringify(data);
        addMsg({side: 'left', text: aiText});
      } catch (e) {
        addMsg({side: 'left', text: '请求失败，请检查后端服务或跨域设置。'});
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

    // 小提示：修改后端地址时可在浏览器控制台执行：
    // localStorage.setItem('NEXA_API','http://localhost:8000')
    // 然后强刷（Ctrl/Cmd + F5）或在 URL 加 ?v=2 避免缓存
  </script>
</body>
</html>
