<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Nexa-Hub · Chat</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #f4f4f4;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
    }
    .app {
      height: 100%;
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      background: #fff;
      box-shadow: 0 2px 16px rgba(0,0,0,.06);
    }

    .header {
      padding: 12px 16px;
      font-weight: 700;
      font-size: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .toolbar {
      padding: 8px 16px;
      border-bottom: 1px solid #f2f2f2;
    }

    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px 8px;
      background: #f6f6f6;
    }

    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      margin: 10px 0;
      max-width: 80%;
    }
    .left  { justify-content: flex-start; }
    .right { justify-content: flex-end; margin-left: auto; }

    .avatar {
      width: 36px; height: 36px; border-radius: 50%; flex: 0 0 36px;
      background: #ddd; object-fit: cover;
    }

    .bubble {
      position: relative;
      padding: 10px 12px;
      border-radius: 8px;
      line-height: 1.5;
      word-break: break-word;
      background: #fff;
      box-shadow: 0 1px 1px rgba(0,0,0,.03);
    }
    .right .bubble {
      background: #9fe770;
    }

    .composer {
      position: sticky; bottom: 0; left: 0; right: 0;
      padding: 10px 12px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex; gap: 10px;
    }
    .composer input[type="text"]{
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
      font-size: 14px;
      background: #fafafa;
    }
    .composer button{
      padding: 8px 16px;
      border: none;
      border-radius: 18px;
      background: #25a244; color: #fff; cursor: pointer;
    }
    .composer button:disabled { opacity: .6; cursor: not-allowed; }

    .chat-bottom-spacer { height: 8px; }

    .toolbar button {
      margin-left: 8px;
      padding: 4px 10px;
      background: #eee;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .toolbar button:hover {
      background: #ddd;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <span>Nexa-Hub - AI Chat</span>
      <small id="session-label" style="color:#888;font-size:12px;"></small>
    </div>

    <div class="toolbar">
      模型：
      <select id="model">
        <option value="openai:gpt-3.5">OpenAI GPT-3.5</option>
        <option value="openai:gpt-4o-mini">OpenAI GPT-4o mini</option>
        <option value="qwen:turbo">Qwen Turbo</option>
        <option value="gemini:1.5">Gemini 1.5</option>
      </select>
      <button id="newSession">新会话</button>
      <button id="clearChat">清空对话</button>
    </div>

    <div id="chat" class="chat">
      <div class="msg-row left">
        <img class="avatar" src="https://via.placeholder.com/72x72.png?text=AI" alt="AI">
        <div class="bubble">你好，我是你的 AI 助手～</div>
      </div>
      <div class="chat-bottom-spacer"></div>
    </div>

    <div class="composer">
      <input id="q" type="text" placeholder="请输入问题…" />
      <button id="send">发送</button>
    </div>
  </div>

  <script>
    // 后端接口配置
    const API_BASE = localStorage.getItem('NEXA_API') || 'http://127.0.0.1:8000';
    const CHAT_API = `${API_BASE}/api/chat/`;
    const CLEAR_API = `${API_BASE}/api/chat/clear`;

    // 元素引用
    const chatEl = document.getElementById('chat');
    const input  = document.getElementById('q');
    const sendBtn= document.getElementById('send');
    const modelEl= document.getElementById('model');
    const sessionLabel = document.getElementById('session-label');

    // 生成唯一会话ID
    function generateSessionId() {
      return 'sess-' + Date.now().toString(36) + '-' + Math.random().toString(36).substring(2, 8);
    }

    // 从 localStorage 恢复或新建会话
    let currentSessionId = localStorage.getItem('NEXA_SESSION_ID');
    if (!currentSessionId) {
      currentSessionId = generateSessionId();
      localStorage.setItem('NEXA_SESSION_ID', currentSessionId);
    }
    sessionLabel.textContent = `会话: ${currentSessionId}`;

    // 添加消息气泡
    function addMsg({side, text}) {
      const row = document.createElement('div');
      row.className = `msg-row ${side}`;

      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = side === 'right'
        ? 'https://via.placeholder.com/72x72.png?text=Me'
        : 'https://via.placeholder.com/72x72.png?text=AI';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;

      if (side === 'left') {
        row.appendChild(avatar);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
        row.appendChild(avatar);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // 发送消息
    async function send() {
      const text = input.value.trim();
      if (!text) return;

      addMsg({side: 'right', text});
      input.value = '';
      input.focus();

      sendBtn.disabled = true;
      try {
        const res = await fetch(CHAT_API, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            query: text,
            model: modelEl.value,
            session_id: currentSessionId
          })
        });
        const data = await res.json();
        const aiText = data.data?.text || data.text || data.answer || JSON.stringify(data);
        addMsg({side: 'left', text: aiText});
      } catch (e) {
        addMsg({side: 'left', text: '❌ 请求失败，请检查后端服务或跨域设置。'});
      } finally {
        sendBtn.disabled = false;
      }
    }

    // 清空当前会话（后端 + 前端）
    async function clearChat() {
      if (!confirm('确定清空当前对话？')) return;
      chatEl.innerHTML = '';
      addMsg({side: 'left', text: '会话已清空。'});

      try {
        await fetch(CLEAR_API, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ session_id: currentSessionId })
        });
      } catch (e) {
        console.warn('清空失败:', e);
      }
    }

    // 新建会话
    function newSession() {
      currentSessionId = generateSessionId();
      localStorage.setItem('NEXA_SESSION_ID', currentSessionId);
      sessionLabel.textContent = `会话: ${currentSessionId}`;
      chatEl.innerHTML = '';
      addMsg({side: 'left', text: '✨ 新会话已创建。'});
    }

    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });
    document.getElementById('clearChat').addEventListener('click', clearChat);
    document.getElementById('newSession').addEventListener('click', newSession);
  </script>
</body>
</html>
